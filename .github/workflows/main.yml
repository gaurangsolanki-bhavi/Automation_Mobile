name: Android Emulator Tests

on:
  push:
    branches:
      - main
  pull_request:

jobs:
  android-emulator:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repo
        uses: actions/checkout@v3

      - name: Set up JDK 21
        uses: actions/setup-java@v3
        with:
          java-version: '21'
          distribution: 'temurin'

      - name: Set up Android SDK
        uses: android-actions/setup-android@v2
        with:
          api-level: 30
          build-tools: 33.0.2
          ndk: 25.2.9519653

      - name: Run Android Emulator
        uses: reactivecircus/android-emulator-runner@v2
        with:
          api-level: 30
          target: default
          arch: x86_64
          emulator-boot-timeout: 600
          force-avd-creation: true
          disable-animations: true
          emulator-options: -no-window -gpu swiftshader_indirect -no-snapshot -noaudio -no-boot-anim -accel off -no-metrics-collection

      - name: Wait for Emulator Boot
        run: |
          echo "⏳ Waiting for emulator to boot..."
          timeout=300
          elapsed=0
          while [ "$(adb shell getprop sys.boot_completed | tr -d '\r')" != "1" ]; do
            sleep 5
            elapsed=$((elapsed+5))
            if [ $elapsed -gt $timeout ]; then
              echo "❌ Emulator failed to boot in $timeout seconds"
              adb logcat -d
              exit 1
            fi
          done
          echo "✅ Emulator booted successfully!"

      - name: Disable animations & unlock screen
        run: |
          adb shell settings put global window_animation_scale 0
          adb shell settings put global transition_animation_scale 0
          adb shell settings put global animator_duration_scale 0
          adb shell settings put global screen_off_timeout 2147483647
          adb shell wm dismiss-keyguard || true
          adb shell am start -a android.intent.action.MAIN -c android.intent.category.HOME
          adb shell svc power stayon true

      - name: Run Android Tests
        run: |
          npm install
          npm run test android profile

      - name: Terminate Emulator
        if: always()
        run: adb -s emulator-5554 emu kill || true

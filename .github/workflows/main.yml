name: Android Tests

on:
  push:
    branches: [main]

jobs:
  android-tests:
    runs-on: macos-latest

    env:
      JAVA_HOME: /Library/Java/JavaVirtualMachines/temurin-21.jdk/Contents/Home
      ANDROID_HOME: /Users/runner/Library/Android/sdk
      ANDROID_SDK_ROOT: /Users/runner/Library/Android/sdk

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Set up JDK 21
      uses: actions/setup-java@v3
      with:
        distribution: temurin
        java-version: 21

    - name: Install Android SDK components
      run: |
        yes | sdkmanager "platform-tools" "platforms;android-30" "system-images;android-30;default;x86_64"

    - name: Start Android Emulator
      uses: reactivecircus/android-emulator-runner@v2
      with:
        api-level: 30
        target: default
        arch: x86_64
        emulator-boot-timeout: 300
        force-avd-creation: true
        disable-animations: true
        cores: 2
        avd-name: test
        emulator-port: 5554
        emulator-options: -no-window -gpu host -no-snapshot -noaudio -no-boot-anim

    - name: Run Android Tests
      run: npm install && npm run test android connectToWiFi

    - name: Stop Emulator
      run: adb -s emulator-5554 emu kill || true

name: Android Tests

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  android-emulator-tests:
    runs-on: macos-latest

    env:
      JAVA_HOME: /opt/hostedtoolcache/Java_Temurin-Hotspot_jdk/21.0.8-9/x64
      ANDROID_HOME: /usr/local/lib/android/sdk
      ANDROID_SDK_ROOT: /usr/local/lib/android/sdk
      AVD_NAME: test

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up JDK 21
        uses: actions/setup-java@v3
        with:
          java-version: 21
          distribution: temurin

      - name: Accept Android licenses
        run: yes | $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager --licenses

      - name: Install SDK packages
        run: |
          $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager "platform-tools" "emulator" "platforms;android-30" "system-images;android-30;default;x86_64"

      - name: Create AVD
        run: |
          echo "no" | $ANDROID_HOME/cmdline-tools/latest/bin/avdmanager create avd -n $AVD_NAME -k "system-images;android-30;default;x86_64" --force

      - name: Start Emulator
        run: |
          $ANDROID_HOME/emulator/emulator -avd $AVD_NAME \
            -no-window -gpu swiftshader_indirect -no-snapshot -noaudio -no-boot-anim -accel off &

          echo "Waiting for emulator to start..."
          $ANDROID_HOME/platform-tools/adb wait-for-device

          # Wait until fully booted
          boot_completed=""
          timeout=0
          while [[ "$boot_completed" != "1" && $timeout -lt 900 ]]; do
            boot_completed=$($ANDROID_HOME/platform-tools/adb shell getprop sys.boot_completed 2>/dev/null | tr -d '\r')
            sleep 5
            timeout=$((timeout + 5))
          done

          if [[ "$boot_completed" != "1" ]]; then
            echo "‚ùå Emulator failed to boot in 15 minutes"
            exit 1
          fi

      - name: Run Tests
        run: |
          # Wait a few seconds to ensure emulator is stable
          sleep 10
          # Replace with your test command
          npm install
          npm run test android profile

      - name: Stop Emulator
        run: |
          $ANDROID_HOME/platform-tools/adb -s emulator-5554 emu kill || true
